"use strict";globalThis.onRimeNotification=(t,e)=>{switch(t){case"deploy":dispatch("deployStatusChanged",e);break;case"schema":dispatch("schemaChanged",...e.split("/"));break;case"option":{const s=e[0]==="!";dispatch("optionChanged",e.slice(+s),!s);break}}};function dispatch(t,...e){postMessage({type:"listener",name:t,args:e})}function syncUserDirectory(t){return new Promise((e,s)=>{Module.FS.syncfs(t==="read",i=>i?s(i):e())})}const actions={async setOption(t,e){Module.ccall("set_option",null,["string","number"],[t,+e])},async processKey(t){const e=JSON.parse(Module.ccall("process_key","string",["string"],[t]));return"committed"in e&&await syncUserDirectory("write"),e},async selectCandidate(t){return JSON.parse(Module.ccall("select_candidate","string",["number"],[t]))},async deleteCandidate(t){return JSON.parse(Module.ccall("delete_candidate","string",["number"],[t]))},async flipPage(t){return JSON.parse(Module.ccall("flip_page","string",["boolean"],[t]))},async customize({pageSize:t,enableCompletion:e,enableCorrection:s,enableSentence:i,enableLearning:n,isCangjie5:o}){return Module.ccall("customize","boolean",["number","number"],[t,[!o,!n,!i,s,!e,!0].reduce((r,a)=>r<<1|+a,0)])},async deploy(){const t=Module.ccall("deploy","boolean",[],[]);return await syncUserDirectory("write"),t}};let loading=!0;const RIME_USER_DIR="/rime",loadRime=new Promise(t=>{globalThis.Module={printErr(e){if(location.search==="?debug"){const s=/^([IWEF])\S+ \S+ \S+ (.*)$/.exec(e);s?console[{I:"info",W:"warn",E:"error",F:"error"}[s[1]]](`[${s[2]}`):console.error(e)}},async onRuntimeInitialized(){Module.FS.mkdir(RIME_USER_DIR),Module.FS.mount(IDBFS,{},RIME_USER_DIR),await syncUserDirectory("read");const e=Module.ccall("init","boolean",[],[]);await syncUserDirectory("write"),loading=!1,dispatch("initialized",e),t()},locateFile(e){return e}},importScripts("rime.js")});addEventListener("message",async({data:{name:t,args:e}})=>{loading&&await loadRime;try{const s=await actions[t](...e);postMessage({type:"success",result:s})}catch(s){postMessage({type:"error",error:s})}});
